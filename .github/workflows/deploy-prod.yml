name: Deploy to Firebase Hosting and Cloud Run (prod)
on:
  push:
    branches: [ "main" ]
    paths:
      - "gigin-api/**"
      - "src/**"
      - ".github/workflows/deploy-prod.yml"
      - "package.json"
      - "functions/**"
  workflow_dispatch:

env:
  PROJECT_ID: giginltd-16772
  REGION: europe-west3
  SERVICE_NAME: gigin-api-prod

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest
    needs: deploy_cloud_run
    env:
      FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
      VITE_FIREBASE_API_KEY: ${{ secrets.PROD_FIREBASE_API_KEY }}
      VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.PROD_FIREBASE_AUTH_DOMAIN }}
      VITE_FIREBASE_PROJECT_ID: ${{ secrets.PROD_FIREBASE_PROJECT_ID }}
      VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.PROD_FIREBASE_STORAGE_BUCKET }}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.PROD_FIREBASE_MESSAGING_SENDER_ID }}
      VITE_FIREBASE_APP_ID: ${{ secrets.PROD_FIREBASE_APP_ID }}
      VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.PROD_FIREBASE_MEASUREMENT_ID }}
      VITE_RECAPTCHA_V3_SITE_KEY: ${{ secrets.PROD_RECAPTCHA_V3_SITE_KEY }}
      VITE_MAPBOX_TOKEN: ${{ secrets.PROD_MAPBOX_TOKEN }}
      VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.PROD_STRIPE_PUBLISHABLE_KEY }}
      VITE_STRIPE_ACCOUNT_URL: ${{ secrets.PROD_STRIPE_ACCOUNT_URL }}
      VITE_STRIPE_ACCOUNT_SESSION_URL: ${{ secrets.PROD_STRIPE_ACCOUNT_SESSION_URL }}
      VITE_API_URL: https://gigin-api-prod-gxujnzd2uq-ey.a.run.app/api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 22, registry-url: https://registry.npmjs.org }
      - run: npm ci
      - run: npm run build -- --mode production
      - run: npm install -g firebase-tools
      - run: firebase deploy --only hosting:prod --project giginltd-16772
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  deploy_cloud_run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Build and Deploy to Cloud Run
        working-directory: gigin-api
        run: |
          gcloud builds submit \
            --config cloudbuild-prod.yaml \
            --project ${{ env.PROJECT_ID }}

      - name: Get Cloud Run URL
        id: url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format 'value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service deployed to: $SERVICE_URL"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Cloud Run Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY